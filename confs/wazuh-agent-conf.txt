<!--
  Wazuh - Agent - Custom Configuration
-->

<ossec_config>
  <client>
    <server>
      <address>{{ wazuh_ip }}</address>
      <port>1514</port>
      <protocol>tcp</protocol>
    </server>
    <config-profile>ubuntu, ubuntu24, ubuntu24.04</config-profile>
    <notify_time>5</notify_time>
    <time-reconnect>30</time-reconnect>
    <auto_restart>yes</auto_restart>
    <crypto_method>aes</crypto_method>
  </client>

  <client_buffer>
    <!-- Agent buffer options -->
    <disabled>no</disabled>
    <queue_size>10000</queue_size>
    <events_per_second>1000</events_per_second>
  </client_buffer>

  <!-- Policy monitoring - REDUZIDO para essencial -->
  <rootcheck>
    <disabled>yes</disabled>
  </rootcheck>

  <wodle name="cis-cat">
    <disabled>yes</disabled>
    <timeout>1800</timeout>
    <interval>1d</interval>
    <scan-on-start>yes</scan-on-start>

    <java_path>wodles/java</java_path>
    <ciscat_path>wodles/ciscat</ciscat_path>
  </wodle>

  <!-- Osquery integration -->
  <wodle name="osquery">
    <disabled>yes</disabled>
    <run_daemon>yes</run_daemon>
    <log_path>/var/log/osquery/osqueryd.results.log</log_path>
    <config_path>/etc/osquery/osquery.conf</config_path>
    <add_labels>yes</add_labels>
  </wodle>

  <!-- System inventory -->
  <wodle name="syscollector">
    <disabled>no</disabled>
    <interval>5s</interval>
    <scan_on_start>yes</scan_on_start>
    <hardware>no</hardware>
    <os>no</os>
    <network>yes</network>
    <packages>no</packages>
    <ports all="yes">yes</ports>
    <processes>yes</processes>

    <!-- Database synchronization settings -->
    <synchronization>
      <max_eps>100</max_eps>
    </synchronization>
  </wodle>

  <!-- SCA  -->
  <sca>
    <enabled>no</enabled>
  </sca>

  <!-- File integrity monitoring -->
  <syscheck>
    <disabled>yes</disabled>
  </syscheck>

  <!-- Log analysis -->
  <localfile>
    <log_format>audit</log_format>
    <location>/var/log/audit/audit.log</location>
  </localfile>

  <!-- Active response -->
  <active-response>
    <disabled>no</disabled>
    <ca_store>etc/wpk_root.pem</ca_store>
    <ca_verification>yes</ca_verification>
  </active-response>

  <!-- Choose between "plain", "json", or "plain,json" for the format of internal logs -->
  <logging>
    <log_format>plain</log_format>
  </logging>

</ossec_config>

<ossec_config>
  <localfile>
    <log_format>journald</log_format>
    <location>journald</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/ossec/logs/active-responses.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/dpkg.log</location>
  </localfile>

  <!-- Monitoramento de comandos TEMPO REAL para InfoStealer -->
  <localfile>
    <log_format>command</log_format>
    <command>ps aux | grep -E "python|systemd" | grep -v grep</command>
    <frequency>5</frequency>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>netstat -tunp | grep -E ":80|:443|:8080" | grep -v "127.0.0.1"</command>
    <frequency>10</frequency>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>systemctl --user list-units --type=service --state=running</command>
    <frequency>30</frequency>
  </localfile>

  <!-- Monitoramento especÃ­fico para arquivos Python maliciosos -->
  <localfile>
    <log_format>command</log_format>
    <command>find /home -name "*.py" -mtime -0.01 -exec ls -la {} \; 2>/dev/null | head -20</command>
    <frequency>15</frequency>
  </localfile>

  <!-- Monitoramento de processos Python ativos -->
  <localfile>
    <log_format>command</log_format>
    <command>lsof -i -P | grep python | grep -v "127.0.0.1"</command>
    <frequency>10</frequency>
  </localfile>

</ossec_config>
