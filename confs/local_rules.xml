<!-- Wazuh Local Rules for InfoStealer Detection -->
<group name="infostealer,preventive_security,hardening">

  <!-- Regra base para capturar todas as conex√µes de rede -->
  <rule id="100300" level="3">
    <if_group>audit</if_group>
    <field name="audit.key">network_connection</field>
    <description>Conex√£o de rede detectada para $(audit.addr).</description>
  </rule>

  <!-- Zero Trust: Bloquear conex√µes para IPs N√ÉO CONFI√ÅVEIS -->
  <rule id="100301" level="12">
    <if_sid>100300</if_sid>
    <!-- Negar IPs de redes privadas, localhost e servi√ßos confi√°veis -->
    <field name="audit.addr" negate="yes">^127\.0\.0\.1$|^172\.16\.|^10\.|^192\.168\.|^::1$|^8\.8\.8\.8$|^8\.8\.4\.4$|^1\.1\.1\.1$|^142\.250\.|^172\.217\.|^216\.58\.192\.|^151\.101\.|^185\.125\.190\.36$|^199\.232\.|^91\.189\.88\.|^91\.189\.95\.83$|^140\.82\.112\.|^185\.199\.108\.|^63\.245\.208\.|^13\.107\.42\.14$|^40\.76\.4\.15$|^91\.189\.91\.|^104\.16\.|^172\.64\.|^54\.230\.|^54\.239\.128\.|^52\.1\.</field>
    <!-- Negar conex√µes para portas comuns de administra√ß√£o e servi√ßos leg√≠timos -->
    <field name="audit.port" negate="yes">^22$|^53$|^80$|^123$|^443$|^514$|^1514$|^1515$</field>
    <description>üö® ZERO TRUST VIOLATION: Conex√£o N√ÉO AUTORIZADA para IP externo $(audit.addr):$(audit.port) pelo processo $(audit.exe).</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1071.002</id>
      <id>T1090</id>
    </mitre>
  </rule>

  <!-- Alerta espec√≠fico para portas HTTP/HTTPS suspeitas -->
  <rule id="100302" level="13">
    <if_group>audit</if_group>
    <field name="audit.key">infostealer_c2_connection</field>
    <description>ALERTA CR√çTICO: Conex√£o C2 suspeita detectada para $(audit.addr):$(audit.port).</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1071.002</id>
    </mitre>
  </rule>

  <!-- Regra melhorada para acesso a arquivos sens√≠veis - reduzir falsos positivos -->
  <rule id="100303" level="12">
    <if_group>audit</if_group>
    <field name="audit.key">prevent_theft</field>
    <!-- Filtrar comandos comuns do sistema que s√£o leg√≠timos -->
    <field name="audit.exe" negate="yes">^/usr/bin/find$|^/bin/find$|^/usr/bin/locate$|^/usr/bin/updatedb$|^/var/ossec/|^/usr/sbin/|^/sbin/|^/usr/bin/ls$|^/bin/ls$|^/usr/bin/cat$|^/bin/cat$|^/usr/bin/grep$|^/bin/grep$|^/usr/bin/less$|^/usr/bin/more$|^/usr/bin/head$|^/usr/bin/tail$</field>
    <!-- Filtrar usu√°rio wazuh -->
    <field name="audit.uid" negate="yes">^113$</field>
    <!-- Apenas alertar para acessos realmente suspeitos (n√£o navega√ß√£o normal) -->
    <field name="audit.syscall">257|2|openat|open</field>
    <description>PREVEN√á√ÉO: Acesso suspeito a arquivos sens√≠veis ($(audit.directory.name)) pelo processo '$(audit.exe)' (PID: $(audit.pid)).</description>
    <mitre>
      <id>T1555</id>
      <id>T1552</id>
    </mitre>
  </rule>

  <!-- Detectar modifica√ß√µes em systemd user services -->
  <rule id="100304" level="10">
    <if_group>audit</if_group>
    <field name="audit.key">systemd_user_service_mod</field>
    <description>‚ö†Ô∏è PERSIST√äNCIA DETECTADA: Modifica√ß√£o em Systemd user service - INVESTIGAR: $(audit.file.name)</description>
    <mitre>
      <id>T1543.002</id>
    </mitre>
  </rule>

  <!-- Detectar execu√ß√£o de Python suspeita -->
  <rule id="100305" level="8">
    <if_group>audit</if_group>
    <field name="audit.key">python_exec</field>
    <!-- Filtrar scripts leg√≠timos conhecidos -->
    <field name="audit.cmdline" negate="yes">/usr/bin/|/usr/lib/|apt|dpkg|ubuntu-advantage</field>
    <description>TTP Detectado: Execu√ß√£o de script Python ('$(audit.exe)') - Comando: $(audit.cmdline)</description>
    <mitre>
      <id>T1059.006</id>
    </mitre>
  </rule>

  <rule id="100306" level="9">
    <if_group>audit</if_group>
    <field name="audit.key">directory_creation</field>
    <description>TTP Detectado: Cria√ß√£o de diret√≥rio em local suspeito - $(audit.cwd)</description>
    <mitre>
      <id>T1036.005</id>
      <id>T1070.004</id>
    </mitre>
  </rule>

  <!-- Zero Trust espec√≠fico para Python fazendo conex√µes externas -->
  <rule id="100307" level="13">
    <if_sid>100301</if_sid>
    <field name="audit.exe">python|python3</field>
    <description>üî• CR√çTICO: Script Python $(audit.exe) fazendo conex√£o N√ÉO AUTORIZADA para $(audit.addr):$(audit.port) - Poss√≠vel C2!</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1059.006</id>
    </mitre>
  </rule>

  <!-- Zero Trust para processos suspeitos (curl, wget, nc) -->
  <rule id="100308" level="11">
    <if_sid>100301</if_sid>
    <field name="audit.exe">curl|wget|nc|netcat|telnet</field>
    <description>SUSPEITO: Ferramenta de rede $(audit.exe) fazendo conex√£o externa para $(audit.addr):$(audit.port).</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1105</id>
    </mitre>
  </rule>

  <!-- Regra de auditoria para conex√µes a sites confi√°veis (n√≠vel baixo) -->
  <rule id="100309" level="3">
    <if_sid>100300</if_sid>
    <!-- Corresponder apenas IPs de servi√ßos confi√°veis -->
    <field name="audit.addr">^142\.250\.|^172\.217\.|^216\.58\.192\.|^151\.101\.|^185\.125\.190\.36$|^199\.232\.|^91\.189\.88\.|^91\.189\.95\.83$|^140\.82\.112\.|^185\.199\.108\.|^63\.245\.208\.|^13\.107\.42\.14$|^40\.76\.4\.15$|^91\.189\.91\.|^104\.16\.|^172\.64\.|^54\.230\.|^54\.239\.128\.|^52\.1\.</field>
    <description>‚úÖ AUDIT: Conex√£o autorizada para servi√ßo confi√°vel $(audit.addr):$(audit.port) pelo processo $(audit.exe).</description>
  </rule>

  <!-- Nova: Detec√ß√£o de scripts em locais suspeitos -->
  <rule id="100310" level="14">
    <if_group>audit</if_group>
    <field name="audit.key">python_exec</field>
    <!-- Detectar scripts em locais n√£o convencionais -->
    <field name="audit.cmdline">\.local/share/|/tmp/|/var/tmp/|/dev/shm/|/home/.*/\.</field>
    <description>üé≠ MASQUERADING: Script suspeito em local n√£o convencional: '$(audit.cmdline)'</description>
    <mitre>
      <id>T1036.005</id>
      <id>T1059.006</id>
    </mitre>
  </rule>

  <!-- Regra de correla√ß√£o para detectar cadeia de ataque completa -->
  <rule id="100399" level="14" frequency="2" timeframe="300">
    <if_matched_sid>100301,100302,100303,100304,100305</if_matched_sid>
    <description>üö® ALERTA M√ÅXIMO: Cadeia de ataque infostealer completa detectada - conex√£o n√£o autorizada + execu√ß√£o Python + persist√™ncia + roubo de dados.</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1059.006</id>
      <id>T1543.002</id>
      <id>T1552</id>
    </mitre>
  </rule>

</group>